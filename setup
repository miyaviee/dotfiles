#!/bin/bash

git fetch -p
git merge origin/master

# vim-plug
test -e ~/.vim/autoload/plug.vim || curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
  https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

test -e ~/.zplug/init.zsh || git clone https://github.com/zplug/zplug ~/.zplug

# filetype conf
for name in `ls -a`; do
  if [ -d ${name} ]; then
    test ${name:0:1} = '.' && continue
    test -L ~/.vim/${name} && continue

    rm -rf ~/.vim/${name}
    ln -fs `pwd`/${name} ~/.vim/${name}
    continue
  fi

  test ${name:0:1} = '.' && ln -fs `pwd`/${name} ~/${name}
done

PACKAGES='virtualenv flake8 autopep8'
PIP3=`which pip3 || which pip`
${PIP3} install ${PACKAGES}
PYTHON3=`which python3 || which python`
test -d ~/neovim3 || ${PYTHON3} -m virtualenv ~/neovim3
source ~/neovim3/bin/activate
pip install neovim
deactivate

PIP2=`which pip2 || which pip`
${PIP2} install ${PACKAGES}
PYTHON2=`which python2 || which python`
test -d ~/neovim2 || ${PYTHON2} -m virtualenv ~/neovim2
source ~/neovim2/bin/activate
pip install neovim
deactivate

test -L ~/.config/nvim || ln -fs ~/.vim ~/.config/nvim
test -L ~/.config/nvim/init.vim || ln -fs ~/.vimrc ~/.config/nvim/init.vim

nvim +:PlugInstall +:q +:PlugClean +:q +:q

export GOPATH=~/.go
type golint > /dev/null 2>&1 || go get -u github.com/golang/lint/golint
type goimports > /dev/null 2>&1 || go get golang.org/x/tools/cmd/goimports

if [ ! -d ~/.pip ]; then
  mkdir ~/.pip
  cat <<EOS > ~/.pip/pip.conf
[list]
format=columns
EOS
fi

test -e ~/.config || mkdir ~/.config
for name in `ls -a .config`; do
  test ${name:0:1} = '.' && continue
  test -L ~/.config/${name} && continue

  rm -rf ~/.config/${name}
  ln -fs `pwd`/.config/${name} ~/.config/${name}
done

test -L ~/.git_tmp || ln -fs `pwd`/.git_tmp ~/.git_tmp
test -z "$(git config --global --get init.templatedir)" && git config --global init.templatedir ~/.git_tmp

# del dead link
for link in ~/.*; do
  test -L $link || continue
  test -e "$(readlink $link)" && continue
  unlink $link
done
